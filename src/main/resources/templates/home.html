<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" th:href="@{/style.css}">
<script  th:src="@{js/jquery-3.7.1.min.js}"></script>
<script  th:src="@{js/script.js}"></script>

<title>食材一覧</title>
</head>
<body>
	<h1>食材一覧</h1>
	<a th:href="@{/users/add}">食材追加</a>
	<a th:href="@{/users/shoppingList}">買い物リスト</a>
	
	<!-- ✅ 成功メッセージ表示部分 -->
	<div id="popupMessage"
	     th:if="${successMessage}"
	     th:text="${successMessage}"
	     class="popup-message">
	</div>
	
	<table>
		<tr>
			<th></th>
			<th>食材</th>
			<th>カテゴリー</th>
			<th>量</th>
			<th>期限</th>
			<th>購入日</th>
			<th>その他</th>
			<th></th>
		</tr>

		<tr th:each="item : ${items}">
		    <td><a th:href="@{/users/edit/{id}(id=${item.id})}">編集</a></td>
		    <td th:text="${item.name}"></td>
		    <td th:text="${item.categoryName}"></td>
		    <td th:text="${item.amount}"></td>
		    <td th:text="${item.deadline}"></td>
		    <td th:text="${item.purchaseDate}"></td>
		    <td th:text="${item.others}"></td>
			<td>
			    <form th:action="@{/users/favorite/{id}(id=${item.id})}" method="post">
			        <button type="submit"
			                th:style="${item.favorite} ? 'color:pink; font-size:20px;' : 'color:gray; font-size:20px;'"
			                style="background:none; border:none; cursor:pointer;">
			            &#10084;
			        </button>
			    </form>
			</td>

		    <!-- stopボタン -->
		    <td>
		        <form th:action="@{/users/stop/{id}(id=${item.id})}" method="post"
		              onsubmit="return confirm('使い切りましたか？');">
		            <input type="submit" value="使い切った！" class="button">
		        </form>
		    </td>

		    <td th:if="${item.expiringSoon}" style="color:red;">気を付けて！</td>
		    <td th:if="${!item.expiringSoon}"></td>
		</tr>
		

		
		<style>
		  .popup-message {
		    position: fixed;
		    top: 20px;
		    right: 20px;
		    background-color: #4CAF50;
		    color: white;
		    padding: 10px 20px;
		    border-radius: 8px;
		    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		    z-index: 1000;
		    opacity: 0.95;
		    font-weight: bold;
		    transition: opacity 0.5s ease-out;
		  }
		</style>

		<script th:inline="javascript">
		  // ページ読み込み時にポップアップを2.5秒後に消す
		  window.addEventListener('DOMContentLoaded', function() {
		    const popup = document.getElementById('popupMessage');
		    if (popup) {
		      setTimeout(() => {
		        popup.style.opacity = '0';
		        setTimeout(() => popup.remove(), 500); // フェードアウト後に削除
		      }, 2500);
		    }
			
			const confirmAdd = /*[[${confirmAddToList}]]*/ false;
			const targetItemId = /*[[${targetItemId}]]*/ 0;
			
			
			// --- ここから追加 ---
			console.log("confirmAdd:", confirmAdd);
			console.log("targetItemId:", targetItemId);
			// --- ここまで追加 ---

			    if (confirmAdd) {
			      const result = confirm('お気に入り登録されています。\n買い物リストに追加しますか？');
				  
				  // --- ここから追加 ---
				  console.log("User clicked 'はい'? ", result);
				  // --- ここまで追加 ---
				  
			      if (result) {
			        // 「はい」→ 買い物リスト追加リクエストを送信
			        fetch(`/users/add-to-shopping-list/${targetItemId}`, {
			          method: 'POST'
			        }).then(() => {
			          alert('買い物リストに追加しました！');
			        });
			      }
			    }
			
		  });
		</script>
			
		
	</table>
</body>
</html>
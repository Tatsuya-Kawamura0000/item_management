<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>é£Ÿæä¸€è¦§</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Baloo 2', cursive;
    background-color: #f0f8ff; /* æ˜ã‚‹ã„å†·è”µåº«é¢¨ */
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    font-weight: 600;
    font-size: 28px;
    margin-bottom: 20px;
}

/* é£Ÿæä¸€è¦§ã‚’å›²ã‚€èƒŒæ™¯ */
.table-wrapper {
    background-color: #ffffff; /* ç™½èƒŒæ™¯ */
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-width: 1200px;
    margin: 0 auto;
}

.table-container {
    overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}

th, td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-weight: 500;
    white-space: nowrap; /* æŠ˜ã‚Šè¿”ã—ç¦æ­¢ */
    overflow: hidden;
    text-overflow: ellipsis;
}

.hidden {
    display: none; /* éè¡¨ç¤º */
}

.button {
    padding: 4px 10px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    background-color: #ffcc80;
    font-weight: 600;
    box-shadow: 1px 2px 3px rgba(0,0,0,0.2);
}

.button:hover { background-color: #ffb74d; }

.heart-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 22px;
}

.selected-row { background-color: #ffe6e6; }

a.button {
    text-decoration: none;
    color: #4a148c;
}
a.button:hover { color: #6a1b9a; }

.popup-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    opacity: 0.95;
    font-weight: bold;
    transition: opacity 0.5s ease-out;
}
</style>
</head>
<body>
	<h1 style="
	    font-family: 'Baloo 2', cursive;
	    font-weight: 700;
	    font-size: 32px;
	    text-align: center;
	    background-color: #ffe5b4;  /* ã†ã™ã„ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
	    padding: 15px 30px;
	    border-radius: 20px;
	    box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
	    display: inline-block;
	">
	    ğŸ¥¦é£Ÿæä¸€è¦§ğŸ¥•
	</h1>

<div style="text-align:right; margin-bottom:10px;">
    <a th:href="@{/users/add}" class="button">é£Ÿæè¿½åŠ </a>
    <a th:href="@{/users/shoppingList}" class="button">è²·ã„ç‰©ãƒªã‚¹ãƒˆ</a>
</div>

<!-- âœ… ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
<form th:action="@{/users/filter}" method="get" style="margin-bottom: 15px;">
    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</label>
    <select name="category">
        <option value="">-- å…¨ã¦ --</option>
        <option th:each="cat : ${categories}" 
                th:value="${cat.id}" 
                th:text="${cat.name}"
				th:selected="${cat.id == selectedCategory}"></option>
    </select>

    <label style="margin-left:10px;">
        <input type="checkbox" name="expiringSoon" value="true"
               th:checked="${param.expiringSoon}"> æœŸé™ãŒè¿‘ã„ã‚‚ã®
    </label>

    <button type="submit" class="button">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
</form>

<div id="popupMessage" th:if="${successMessage}" th:text="${successMessage}" class="popup-message"></div>

<!-- é£Ÿæä¸€è¦§ã‚’å›²ã‚€ -->
<div class="table-wrapper">
    <div class="table-container">
        <table>
            <tr>
                <th>ç·¨é›†</th>
                <th>é£Ÿæ</th>
                <th class="hidden">ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
                <th>é‡</th>
                <th>æœŸé™</th>
                <th>ãƒ¡ãƒ¢</th>
                <th>ãŠæ°—ã«å…¥ã‚Š</th>
                <th></th>
                <th></th>
            </tr>

            <tr th:each="item : ${items}">
                <td><a th:href="@{/users/edit/{id}(id=${item.id})}" class="button">ç·¨é›†</a></td>
                <td th:text="${item.name}"></td>
                <td class="hidden" th:text="${item.categoryName}"></td>
                <td th:text="${item.amount}"></td>
                <td th:text="${item.deadline}"></td>
                <td th:text="${item.others}"></td>
                <td>
                    <form th:action="@{/users/favorite/{id}(id=${item.id})}" method="post">
						<!-- âœ… ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’ä¿æŒã™ã‚‹ hidden -->
						<input type="hidden" name="category" th:value="${selectedCategory}">
						<input type="hidden" name="expiringSoon" th:value="${expiringSoon}">
                        <button type="submit" class="heart-btn"
                            th:style="${item.favorite} ? 'color:pink;' : 'color:gray;'">&#10084;</button>
                    </form>
                </td>
                <td>
                    <!-- âœ… ãŠæ°—ã«å…¥ã‚Šæ™‚ã«ç¢ºèªï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆè¿½åŠ  -->
                    <form th:action="@{/users/stop/{id}(id=${item.id})}" method="post"
                          th:onsubmit="'return handleStop(event,' + ${item.favorite} + ',' + ${item.id} + ');'">
                        <input type="submit" value="ä½¿ã„åˆ‡ã£ãŸï¼" class="button">
                    </form>
                </td>
				<td th:text="${item.message}" style="color:red;"></td>


            </tr>
        </table>
    </div>
</div>

<script th:inline="javascript">
/* âœ… ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è‡ªå‹•ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ */
window.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('popupMessage');
    if (popup) {
        setTimeout(() => {
            popup.style.transition = "opacity 0.5s ease-out";
            popup.style.opacity = '0';
            setTimeout(() => popup.remove(), 500);
        }, 2500);
    }
});

/* âœ… ãŠæ°—ã«å…¥ã‚Šãªã‚‰ã€Œè²·ã„ç‰©ãƒªã‚¹ãƒˆè¿½åŠ ã€ç¢ºèª */
function handleStop(event, isFavorite, itemId) {
    event.preventDefault();
	
	// ğŸŸ¡ ã¾ãšç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
	const confirmed = confirm("ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã‹ï¼Ÿ");
	if (!confirmed) {
	    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆã€å‡¦ç†ã‚’ä¸­æ–­
	}

    if (isFavorite) {
        const addToList = confirm("ã“ã®é£Ÿæã¯ãŠæ°—ã«å…¥ã‚Šã§ã™ã€‚è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ");
        if (addToList) {
            fetch(`/users/add-to-shopping-list/${itemId}`, {
                method: "POST"
            })
            .then(response => {
                if (response.ok) {
                    alert("è²·ã„ç‰©ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼");
                } else {
                    alert("è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            })
            .catch(() => alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"));
        }
    }

    // âœ… ã€Œä½¿ã„åˆ‡ã£ãŸã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
    event.target.submit();
}
</script>
</body>
</html>

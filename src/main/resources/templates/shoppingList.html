<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>è²·ã„ç‰©ãƒªã‚¹ãƒˆ</title>

	<style>
	.memo-container {
	    width: 60%;
	    margin: 20px auto;
	    background: #fff9c4; /* è–„ã„é»„è‰²ã§ãƒ¡ãƒ¢ç´™é¢¨ */
	    padding: 20px;
	    border: 2px dashed #fbc02d;
	    border-radius: 10px;
	    box-shadow: 3px 3px 6px rgba(0,0,0,0.2);
	    font-family: 'Comic Sans MS', cursive;
	}

	table {
	    width: 100%;
	    border-collapse: collapse;
	}

	th, td {
	    padding: 8px 12px;
	    text-align: left;
	    border-bottom: 1px dashed #fbc02d;
	}

	th {
	    background-color: #fff3e0;
	}

	td span.pencil {
	    margin-left: 5px;
	    font-size: 16px;
	    cursor: pointer;
	}

	.button {
	    padding: 6px 12px;
	    font-size: 14px;
	    cursor: pointer;
	    margin: 5px;
	    border-radius: 6px;
	    border: none;
	    background-color: #ffcc80;
	    box-shadow: 1px 2px 4px rgba(0,0,0,0.2);
	}

	.button:hover {
	    background-color: #ffb74d;
	}

	.selected-row {
	    background-color: #ffe6e6; /* ãƒã‚§ãƒƒã‚¯ã—ãŸã‚‰è–„ã„èµ¤ */
	}
	.hidden {
	    display: none;
	}

	.back-container {
	    text-align: center;
	    margin-top: 20px;
	}
	</style>
	
	<!-- â˜… CSRFç„¡åŠ¹åŒ–ã®å ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ -->
	    <!--
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	-->
</head>
<body>
	<h1 style="text-align:center; font-family: 'Comic Sans MS', cursive;">ğŸ“ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h1>

	<div class="memo-container">
	    <div class="control-buttons" style="text-align:right;">
	        <button onclick="checkAll()" class="button">å…¨ã¦ãƒã‚§ãƒƒã‚¯</button>
	        <button onclick="uncheckAll()" class="button">å…¨ã¦è§£é™¤</button>
	    </div>
		
	<div id="message" style="text-align:center; margin:10px 0; color:green;"></div>	

	    <table>
	        <tr>
	            <th>âœ”</th>
	            <th>é£Ÿæ</th>
	            <th>é‡</th>
	            <th class="hidden">ã‚«ãƒ†ã‚´ãƒª</th>
	            <th class="hidden">è³¼å…¥æ—¥</th>
	            <th class="hidden">è³¼å…¥æ¸ˆã¿</th>
	            <th>æ“ä½œ</th>
	        </tr>

	        <tr th:each="item : ${listItems}">
	            <td><input type="checkbox" name="selectedItems"></td>
	            <td>
	                <span th:text="${item.name}"></span>
	                <span class="pencil">âœï¸</span>
	            </td>
	            <td th:text="${item.amount}"></td>
	            <td class="hidden" th:text="${item.categoryName}"></td>
	            <td class="hidden" th:text="${item.purchaseDate}"></td>
	            <td class="hidden" th:text="${item.purchasedFlg}"></td>
	            <td>
					<!-- â˜…JSã«å€¤ã‚’æ¸¡ã™ -->
					<button type="button" class="button"
					        th:attr="data-id=${item.id}, data-name=${item.name}"
					        onclick="openPurchasedModal(this.dataset.id, this.dataset.name)">
					    è³¼å…¥æ¸ˆã¿ã«ã™ã‚‹
					</button>
	            </td>
	        </tr>
	    </table>
	</div>

	<!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
	<button type="button" onclick="goBack()" class="button">é£Ÿæä¸€è¦§ã¸æˆ»ã‚‹</button>

	<script>
	    function goBack() {
	        // /users ã«é·ç§»ã—ã¦æœ€æ–°ã®ä¸€è¦§ã‚’å–å¾—
	        window.location.href = '/users';
	    }
	</script>

	<script>
	    // å…¨ãƒã‚§ãƒƒã‚¯ãƒ»å…¨è§£é™¤
	    function checkAll() {
	        document.querySelectorAll('input[name="selectedItems"]').forEach(cb => {
	            cb.checked = true;
	            highlightRow(cb);
	        });
	    }

	    function uncheckAll() {
	        document.querySelectorAll('input[name="selectedItems"]').forEach(cb => {
	            cb.checked = false;
	            highlightRow(cb);
	        });
	    }

	    // è¡Œã®èƒŒæ™¯è‰²ã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«å¿œã˜ã¦å¤‰æ›´
	    function highlightRow(checkbox) {
	        const row = checkbox.closest('tr');
	        if (checkbox.checked) {
	            row.classList.add('selected-row');
	        } else {
	            row.classList.remove('selected-row');
	        }
	    }

	    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
	    window.addEventListener('DOMContentLoaded', function() {
	        document.querySelectorAll('input[name="selectedItems"]').forEach(cb => {
	            cb.addEventListener('change', () => highlightRow(cb));
	            highlightRow(cb); // åˆæœŸçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
	        });
	    });
		
		// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
		function openPurchasedModal(id, name) {
		    document.getElementById("shoppingListId").value = id;
			// â˜…ã“ã“ã§JSã®å¼•æ•° name ã‚’ã‚»ãƒƒãƒˆ
			document.getElementById("itemName").value = name;
			document.getElementById("purchasedModal").style.display = "flex";
		}

		// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
		function closeModal() {
		    document.getElementById("purchasedModal").style.display = "none";
		}
		
		function submitPurchased() {
		    const id = document.getElementById("shoppingListId").value;
		    const name = document.getElementById("itemName").value;
		    const amount = document.getElementById("amount").value;
		    const deadline = document.getElementById("deadline").value;
		    const others = document.getElementById("others").value;
		    const favorite = document.getElementById("favorite").checked;
			const categoryId = document.getElementById("categoryId").value; // â† ã“ã“ã§å–å¾—

		    const data = {
		        id: id,
		        name: name,
		        amount: amount,
		        deadline: deadline,
		        others: others,
		        favorite: favorite,
				categoryId: categoryId  // â† è¿½åŠ 
		    };
			
			// å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
			    if (!categoryId) {
			        alert("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„");
			        return;
			    }

		    fetch('/users/add-to-shopping-list', {
		        method: 'POST',
		        headers: { 'Content-Type': 'application/json' },
		        body: JSON.stringify(data)
		    })
		    .then(response => {
		        if (!response.ok) throw new Error('Network response was not ok');
		        return response.json();
		    })
		    .then(item => {
		        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
		        const msgDiv = document.getElementById("message");
		        msgDiv.style.color = "green";
		        msgDiv.textContent = "é£Ÿæä¸€è¦§ã«è¿½åŠ ã—ã¾ã—ãŸï¼";

		        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
		        closeModal();

		        // è¿½åŠ ã—ãŸè¡Œã¯è²·ã„ç‰©ãƒªã‚¹ãƒˆã‹ã‚‰éè¡¨ç¤ºã«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
		        const row = document.querySelector(`button[data-id='${id}']`)?.closest('tr');
		        if (row) row.remove();
		    })
		    .catch(error => {
		        console.error('Error:', error);
		        const msgDiv = document.getElementById("message");
		        msgDiv.style.color = "red";
		        msgDiv.textContent = "å¤±æ•—ã—ã¾ã—ãŸ";
		    });
		}
		
	</script>
	
	<!-- â˜…è³¼å…¥æ¸ˆã¿ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
	<div id="purchasedModal" class="modal-overlay" style="display:none;">
	    <div class="modal-content">
	        <h2>è³¼å…¥æ¸ˆã¿ â†’ é£Ÿæã¨ã—ã¦ç™»éŒ²</h2>

	        <form id="purchasedForm">
	            <input type="hidden" name="shoppingListId" id="shoppingListId">

	            <div>
	                <label>é£Ÿæåï¼š</label>
					<!-- â˜…JSã§ã‚»ãƒƒãƒˆ -->
					 <input type="text" id="itemName" name="itemName" readonly>
	            </div>
				
				<div>
				    <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</label>
				    <select id="categoryId" name="categoryId" required>
				        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
				        <option th:each="cat : ${categories}" 
				                th:value="${cat.id}" 
				                th:text="${cat.name}">
				        </option>
				    </select>
				</div>

	            <div>
	                <label>é‡ï¼š</label>
	                <input type="text" id="amount" name="amount" required>
	            </div>

	            <div>
	                <label>æœŸé™ï¼š</label>
	                <input type="date" id="deadline" name="deadline">
	            </div>

	            <div>
	                <label>ãƒ¡ãƒ¢ï¼š</label>
	                <input type="text" id="others" name="others">
	            </div>

	            <div>
	                <label>ãŠæ°—ã«å…¥ã‚Šï¼š</label>
	                <input type="checkbox" id="favorite" name="favorite">
	            </div>

	            <div class="modal-buttons">
	                <button type="button" onclick="submitPurchased()">é£Ÿæä¸€è¦§ã¸è¿½åŠ </button>
	                <button type="button" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
	            </div>
	        </form>
	    </div>
	</div>

</body>
</html>
